name: Build and Deploy to AWS ECR

on:
  push:
    branches: [main]

env:
  AWS_REGION: us-east-2
  ECR_REGISTRY: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.us-east-2.amazonaws.com
  API_IMAGE_NAME: ml-engineering-course/cd-demo

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2

    - name: Build and push FastAPI image
      run: |
        docker build \
          -f Dockerfile.p2_c1_2 \
          -t $ECR_REGISTRY/$API_IMAGE_NAME:${{ github.sha }} \
          -t $ECR_REGISTRY/$API_IMAGE_NAME:latest \
          --build-arg POSTGRES_HOST=postgres \
          --build-arg POSTGRES_PORT=5432 \
          --build-arg POSTGRES_DB=${{ secrets.POSTGRES_DB }} \
          --build-arg POSTGRES_USER=${{ secrets.POSTGRES_USER }} \
          --build-arg POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }} \
          .

        docker push $ECR_REGISTRY/$API_IMAGE_NAME:${{ github.sha }}
        docker push $ECR_REGISTRY/$API_IMAGE_NAME:latest

    - name: Output image URI
      run: |
        echo "FastAPI Image: $ECR_REGISTRY/$API_IMAGE_NAME:${{ github.sha }}"